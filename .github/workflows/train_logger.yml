for i in range(3):
    now = datetime.now()
    try:
        response = requests.post(url, headers=headers, data=data, timeout=10)
        if response.status_code != 200:
            print(f"[{now}] APIエラー: status={response.status_code}")
            continue

        trains = response.json()
    except Exception as e:
        print(f"[{now}] 例外が発生しました: {e}")
        continue

    with open(csv_file, "a", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        for train in trains:
            vid = train.get("vehicle_id")
            formation = id_map.get(str(vid), f"ID:{vid}")
            writer.writerow([
                now.strftime("%Y-%m-%d %H:%M:%S"),
                vid,
                formation,
                train.get("headsign"),
                train.get("teiryujo_name")
            ])

    print(f"[{now}] データを保存しました ({len(trains)}件)")
    time.sleep(30)
