#本番用train_log.csv作成保存コード(外部コードで20分ごとに呼びだし)---------------------------------------------------------------------------------------------------------------------------------


# train_logger.py (Actions用に簡略化)
import requests, csv
from datetime import datetime

url = "https://buscatch.jp/rt3/unko_map_simple.ajax.php"
data = {"id": "chitetsu_train", "command": "get_unko_list", "rosen_group_id": "2235"}
headers = {"User-Agent": "Mozilla/5.0", "X-Requested-With": "XMLHttpRequest"}

id_map = {"1001": "デ7011編成", "1002": "デ7012編成", "2001": "デ7021編成"}

now = datetime.now()
date_str = now.strftime("%Y-%m-%d")
csv_file = f"train_log_{date_str}.csv"

# ヘッダー行を初回のみ書き込み
try:
    open(csv_file, "r")
except FileNotFoundError:
    with open(csv_file, "w", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow(["timestamp", "vehicle_id", "formation_name", "headsign", "station"])

# データ取得
response = requests.post(url, headers=headers, data=data, timeout=10)
trains = response.json()

with open(csv_file, "a", newline="", encoding="utf-8") as f:
    writer = csv.writer(f)
    for train in trains:
        vid = train.get("vehicle_id")
        formation = id_map.get(str(vid), f"ID:{vid}")
        writer.writerow([
            now.strftime("%Y-%m-%d %H:%M:%S"),
            vid,
            formation,
            train.get("headsign"),
            train.get("teiryujo_name")
        ])

print(f"[{now}] データを保存しました ({len(trains)}件



#時刻表csv-----------------------------------------------------------------------------------------------------------------------------------------------------------

import pandas as pd
from datetime import datetime

# 今日の日付に対応したファイル名を生成
date_str = datetime.now().strftime("%Y-%m-%d")
csv_file = f"train_log_{date_str}.csv"

# 運行ログの読み込み
log_df = pd.read_csv(csv_file, encoding="utf-8")
log_df["timestamp"] = pd.to_datetime(log_df["timestamp"], errors="coerce")
log_df["timestamp_jst"] = log_df["timestamp"].dt.tz_localize("Asia/Tokyo")

print("=== 運行ログ (先頭) ===")
print(log_df.head())

# -----------------------------
# 2. 時刻表データの展開 (602〜650レ)
# -----------------------------
stations_down = [
    "岩峅寺","大川寺","上滝","大庄","月岡","開発","布市","小杉",
    "上堀","朝菜町","南富山","大泉","不二越","栄町","稲荷町","電鉄富山"
]

train_nos_down = [602,604,606,608,610,612,614,616,618,620,622,624,
             626,628,630,632,634,636,638,640,642,644,646,648,650]

times_matrix_down = [
    ["5:43","6:13","6:45","7:20","7:58","8:27","9:33","10:33","11:33","12:33","13:33","14:33","15:37","16:10","16:40","17:10","17:40","18:10","18:40","19:10","19:40","20:10","20:40","21:10","22:13"], # 岩峅寺
    ["5:45","6:15","6:47","7:22","8:00","8:29","9:35","10:35","11:35","12:35","13:35","14:35","15:39","16:12","16:42","17:12","17:42","18:12","18:42","19:12","19:42","20:12","20:42","21:12","22:15"], # 大川寺
    ["5:47","6:17","6:49","7:24","8:02","8:31","9:37","10:37","11:37","12:37","13:37","14:37","15:41","16:14","16:44","17:14","17:44","18:14","18:44","19:14","19:44","20:14","20:44","21:14","22:17"], # 上滝
    ["5:50","6:20","6:52","7:27","8:05","8:34","9:40","10:40","11:40","12:40","13:40","14:40","15:44","16:17","16:47","17:17","17:47","18:17","18:47","19:17","19:47","20:17","20:47","21:17","22:20"], # 大庄
    ["5:53","6:24","6:56","7:31","8:09","8:38","9:43","10:43","11:43","12:43","13:43","14:43","15:47","16:20","16:50","17:20","17:50","18:20","18:50","19:20","19:50","20:20","20:50","21:20","22:23"], # 月岡
    ["5:56","6:27","6:59","7:34","8:12","8:41","9:46","10:46","11:46","12:46","13:46","14:46","15:50","16:23","16:53","17:23","17:53","18:23","18:53","19:23","19:53","20:23","20:53","21:23","22:26"], # 開発
    ["5:58","6:29","7:01","7:36","8:14","8:43","9:48","10:48","11:48","12:48","13:48","14:48","15:52","16:25","16:55","17:25","17:55","18:25","18:55","19:25","19:55","20:25","20:55","21:25","22:28"], # 布市
    ["5:59","6:30","7:02","7:37","8:15","8:44","9:49","10:49","11:49","12:49","13:49","14:49","15:53","16:26","16:56","17:26","17:56","18:26","18:56","19:26","19:56","20:26","20:56","21:26","22:29"], # 小杉
    ["6:00","6:31","7:03","7:38","8:16","8:45","9:50","10:50","11:50","12:50","13:50","14:50","15:54","16:27","16:57","17:27","17:57","18:27","18:57","19:27","19:57","20:27","20:57","21:27","22:30"], # 上堀
    ["6:01","6:32","7:04","7:39","8:17","8:46","9:51","10:51","11:51","12:51","13:51","14:51","15:55","16:28","16:58","17:28","17:58","18:28","18:58","19:28","19:58","20:28","20:58","21:28","22:31"], # 朝菜町
    ["6:06","6:39","7:15","7:56","8:25","8:51","9:56","10:56","11:56","12:56","13:56","14:56","15:59","16:33","17:03","17:33","18:03","18:33","19:03","19:33","20:03","20:33","21:03","21:33","22:36"], # 南富山
    ["6:08","6:41","7:17","7:58","8:27","8:53","9:58","10:58","11:58","12:58","13:58","14:58","16:01","16:35","17:05","17:35","18:05","18:35","19:05","19:35","20:05","20:35","21:05","21:35","22:38"], # 大泉
    ["6:10","6:43","7:19","8:00","8:29","8:55","10:00","11:00","12:00","13:00","14:00","15:00","16:03","16:37","17:07","17:37","18:07","18:37","19:07","19:37","20:07","20:37","21:07","21:37","22:40"], # 不二越
    ["6:11","6:44","7:20","8:01","8:30","8:56","10:01","11:01","12:01","13:01","14:01","15:01","16:04","16:38","17:08","17:38","18:08","18:38","19:08","19:38","20:08","20:38","21:08","21:38","22:41"], # 栄町
    ["6:16","6:50","7:23","8:06","8:34","9:00","10:05","11:05","12:05","13:05","14:05","15:05","16:08","16:43","17:12","17:42","18:12","18:42","19:13","19:42","20:12","20:42","21:12","21:43","22:45"], # 稲荷町
    ["6:19","6:53","7:27","8:09","8:37","9:03","10:08","11:08","12:08","13:08","14:08","15:08","16:11","16:46","17:15","17:45","18:15","18:45","19:16","19:45","20:15","20:45","21:15","21:46","22:48"] # 電鉄富山
]

# 上り方向（電鉄富山→岩峅寺）
stations_up = ["電鉄富山","稲荷町","栄町","不二越","大泉","南富山","朝菜町",
                 "上堀","小杉","布市","開発","月岡","大庄","上滝","大川寺","岩峅寺"]

train_nos_up = [601,603,605,607,609,611,613,615,617,619,621,623,625,627,629,631,633,635,637,639,641,643,645,647,649]

# ここに寛佑さんが貼ってくれた時刻表を行ごとにリスト化（16行×25列）
times_matrix_up = [
    ["5:28","5:54","6:28","7:03","7:43","8:11","9:18","10:45","11:45","12:45","13:45","14:45","15:22","15:47","16:22","16:52","17:22","17:52","18:22","18:52","19:22","19:52","20:22","21:22","22:25"], # 電鉄富山
    ["5:32","5:58","6:32","7:07","7:48","8:17","9:22","10:49","11:49","12:49","13:49","14:49","15:26","15:51","16:26","16:56","17:26","17:56","18:26","18:56","19:26","19:56","20:26","21:26","22:29"], # 稲荷町
    ["5:33","5:59","6:33","7:08","7:49","8:18","9:23","10:50","11:50","12:50","13:50","14:50","15:27","15:52","16:27","16:57","17:27","17:57","18:27","18:57","19:27","19:57","20:27","21:27","22:30"], # 栄町
    ["5:34","6:00","6:34","7:09","7:50","8:19","9:24","10:51","11:51","12:51","13:51","14:51","15:28","15:53","16:28","16:58","17:28","17:58","18:28","18:58","19:28","19:58","20:28","21:28","22:31"], # 不二越
    ["5:36","6:02","6:36","7:11","7:52","8:21","9:26","10:53","11:53","12:53","13:53","14:53","15:30","15:55","16:30","17:00","17:30","18:00","18:30","19:00","19:30","20:00","20:30","21:30","22:33"], # 大泉
    ["5:40","6:06","6:40","7:15","7:56","8:25","9:30","10:57","11:57","12:57","13:57","14:57","15:34","15:59","16:34","17:04","17:34","18:04","18:34","19:04","19:34","20:04","20:34","21:34","22:37"], # 南富山
    ["5:42","6:08","6:42","7:17","7:58","8:27","9:32","10:59","11:59","12:59","13:59","14:59","15:36","16:01","16:36","17:06","17:36","18:06","18:36","19:06","19:36","20:06","20:36","21:36","22:39"], # 朝菜町
    ["5:44","6:10","6:44","7:19","8:00","8:29","9:34","11:01","12:01","13:01","14:01","15:01","15:38","16:03","16:38","17:08","17:38","18:08","18:38","19:08","19:38","20:08","20:38","21:38","22:41"], # 上堀
    ["5:45","6:11","6:45","7:20","8:01","8:30","9:35","11:02","12:02","13:02","14:02","15:02","15:39","16:04","16:39","17:09","17:39","18:09","18:39","19:09","19:39","20:09","20:39","21:39","22:42"], # 小杉
    ["5:46","6:12","6:46","7:21","8:02","8:31","9:36","11:03","12:03","13:03","14:03","15:03","15:40","16:05","16:40","17:10","17:40","18:10","18:40","19:10","19:40","20:10","20:40","21:40","22:43"], # 布市
    ["5:48","6:14","6:48","7:23","8:04","8:33","9:38","11:05","12:05","13:05","14:05","15:05","15:42","16:07","16:42","17:12","17:42","18:12","18:42","19:12","19:42","20:12","20:42","21:42","22:45"], # 開発
    ["5:53","6:24","6:56","7:31","8:10","8:39","9:43","11:10","12:10","13:10","14:10","15:10","15:47","16:20","16:49","17:19","17:49","18:19","18:49","19:19","19:49","20:19","20:49","21:47","22:50"], # 月岡
    ["5:55","6:26","6:58","7:33","8:12","8:41","9:45","11:12","12:12","13:12","14:12","15:12","15:49","16:22","16:51","17:21","17:51","18:21","18:51","19:21","19:51","20:21","20:51","21:49","22:52"], # 大庄
    ["5:58","6:29","7:01","7:36","8:15","8:44","9:48","11:15","12:15","13:15","14:15","15:15","15:52","16:25","16:54","17:24","17:54","18:24","18:54","19:24","19:54","20:24","20:54","21:52","22:55"], # 上滝
    ["6:00","6:31","7:03","7:38","8:17","8:46","9:50","11:17","12:17","13:17","14:17","15:17","15:54","16:27","16:56","17:26","17:56","18:26","18:56","19:26","19:56","20:26","20:56","21:54","22:57"], # 大川寺
    ["6:04","6:35","7:07","7:42","8:21","8:50","9:54","11:21","12:21","13:21","14:21","15:21","15:58","16:31","17:00","17:30","18:00","18:30","19:00","19:30","20:00","20:30","21:00","21:58","23:01"] # 岩峅寺
]

# 展開処理
rows = []

# 下り方向
for s_idx, station in enumerate(stations_down):
    for t_idx, train_no in enumerate(train_nos_down):
        time_str = times_matrix_down[s_idx][t_idx]
        rows.append({
            "train_no": train_no,
            "type": "普通",
            "headsign": "電鉄富山",
            "station": station,
            "time": f"1900-01-01 {time_str}:00"
        })

# 上り方向
for s_idx, station in enumerate(stations_up):
    for t_idx, train_no in enumerate(train_nos_up):
        time_str = times_matrix_up[s_idx][t_idx]
        rows.append({
            "train_no": train_no,
            "type": "普通",
            "headsign": "岩峅寺",
            "station": station,
            "time": f"1900-01-01 {time_str}:00"
        })

timetable_df = pd.DataFrame(rows)

print("=== 時刻表 (先頭) ===")
print(timetable_df.head())
print("=== 時刻表 (末尾) ===")
print(timetable_df.tail())
print("行数:", timetable_df.shape)  # 16駅 × 50本 = 800行


#立山線合成仮置きーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー

import pandas as pd

# バリデーション関数
def validate_matrix(stations, train_nos, times_matrix, label):
    if len(times_matrix) != len(stations):
        raise ValueError(f"[{label}] 行数不一致: stations={len(stations)} vs times_matrix={len(times_matrix)}")
    for r, row in enumerate(times_matrix):
        if len(row) != len(train_nos):
            raise ValueError(f"[{label}] 列数不一致: row{r}={len(row)} vs trains={len(train_nos)}")

# -----------------------------
# 不二越・上滝線 下り（岩峅寺→電鉄富山）
# -----------------------------
stations_down_fujikoshi = [
    "岩峅寺","大川寺","上滝","大庄","月岡","開発","布市","小杉",
    "上堀","朝菜町","南富山","大泉","不二越","栄町","稲荷町","電鉄富山"
]

train_nos_down_fujikoshi = [602,604,606,608,610,612,614,616,618,620,622,624,
             626,628,630,632,634,636,638,640,642,644,646,648,650]


times_matrix_down_fujikoshi = [
    ["5:43","6:13","6:45","7:20","7:58","8:27","9:33","10:33","11:33","12:33","13:33","14:33","15:37","16:10","16:40","17:10","17:40","18:10","18:40","19:10","19:40","20:10","20:40","21:10","22:13"], # 岩峅寺
    ["5:45","6:15","6:47","7:22","8:00","8:29","9:35","10:35","11:35","12:35","13:35","14:35","15:39","16:12","16:42","17:12","17:42","18:12","18:42","19:12","19:42","20:12","20:42","21:12","22:15"], # 大川寺
    ["5:47","6:17","6:49","7:24","8:02","8:31","9:37","10:37","11:37","12:37","13:37","14:37","15:41","16:14","16:44","17:14","17:44","18:14","18:44","19:14","19:44","20:14","20:44","21:14","22:17"], # 上滝
    ["5:50","6:20","6:52","7:27","8:05","8:34","9:40","10:40","11:40","12:40","13:40","14:40","15:44","16:17","16:47","17:17","17:47","18:17","18:47","19:17","19:47","20:17","20:47","21:17","22:20"], # 大庄
    ["5:53","6:24","6:56","7:31","8:09","8:38","9:43","10:43","11:43","12:43","13:43","14:43","15:47","16:20","16:50","17:20","17:50","18:20","18:50","19:20","19:50","20:20","20:50","21:20","22:23"], # 月岡
    ["5:56","6:27","6:59","7:34","8:12","8:41","9:46","10:46","11:46","12:46","13:46","14:46","15:50","16:23","16:53","17:23","17:53","18:23","18:53","19:23","19:53","20:23","20:53","21:23","22:26"], # 開発
    ["5:58","6:29","7:01","7:36","8:14","8:43","9:48","10:48","11:48","12:48","13:48","14:48","15:52","16:25","16:55","17:25","17:55","18:25","18:55","19:25","19:55","20:25","20:55","21:25","22:28"], # 布市
    ["5:59","6:30","7:02","7:37","8:15","8:44","9:49","10:49","11:49","12:49","13:49","14:49","15:53","16:26","16:56","17:26","17:56","18:26","18:56","19:26","19:56","20:26","20:56","21:26","22:29"], # 小杉
    ["6:00","6:31","7:03","7:38","8:16","8:45","9:50","10:50","11:50","12:50","13:50","14:50","15:54","16:27","16:57","17:27","17:57","18:27","18:57","19:27","19:57","20:27","20:57","21:27","22:30"], # 上堀
    ["6:01","6:32","7:04","7:39","8:17","8:46","9:51","10:51","11:51","12:51","13:51","14:51","15:55","16:28","16:58","17:28","17:58","18:28","18:58","19:28","19:58","20:28","20:58","21:28","22:31"], # 朝菜町
    ["6:06","6:39","7:15","7:56","8:25","8:51","9:56","10:56","11:56","12:56","13:56","14:56","15:59","16:33","17:03","17:33","18:03","18:33","19:03","19:33","20:03","20:33","21:03","21:33","22:36"], # 南富山
    ["6:08","6:41","7:17","7:58","8:27","8:53","9:58","10:58","11:58","12:58","13:58","14:58","16:01","16:35","17:05","17:35","18:05","18:35","19:05","19:35","20:05","20:35","21:05","21:35","22:38"], # 大泉
    ["6:10","6:43","7:19","8:00","8:29","8:55","10:00","11:00","12:00","13:00","14:00","15:00","16:03","16:37","17:07","17:37","18:07","18:37","19:07","19:37","20:07","20:37","21:07","21:37","22:40"], # 不二越
    ["6:11","6:44","7:20","8:01","8:30","8:56","10:01","11:01","12:01","13:01","14:01","15:01","16:04","16:38","17:08","17:38","18:08","18:38","19:08","19:38","20:08","20:38","21:08","21:38","22:41"], # 栄町
    ["6:16","6:50","7:23","8:06","8:34","9:00","10:05","11:05","12:05","13:05","14:05","15:05","16:08","16:43","17:12","17:42","18:12","18:42","19:13","19:42","20:12","20:42","21:12","21:43","22:45"], # 稲荷町
    ["6:19","6:53","7:27","8:09","8:37","9:03","10:08","11:08","12:08","13:08","14:08","15:08","16:11","16:46","17:15","17:45","18:15","18:45","19:16","19:45","20:15","20:45","21:15","21:46","22:48"]  # 電鉄富山
]
validate_matrix(stations_down_fujikoshi, train_nos_down_fujikoshi, times_matrix_down_fujikoshi, "不二越下り")

# 不二越・上滝線 上り（電鉄富山→岩峅寺）
stations_up_fujikoshi = [
    "電鉄富山","稲荷町","栄町","不二越","大泉","南富山","朝菜町",
    "上堀","小杉","布市","開発","月岡","大庄","上滝","大川寺","岩峅寺"
]
train_nos_up_fujikoshi = [601,603,605,607,609,611,613,615,617,619,621,623,625,627,629,631,633,635,637,639,641,643,645,647,649]
times_matrix_up_fujikoshi = [
    ["5:28","5:54","6:28","7:03","7:43","8:11","9:18","10:45","11:45","12:45","13:45","14:45","15:22","15:47","16:22","16:52","17:22","17:52","18:22","18:52","19:22","19:52","20:22","21:22","22:25"], # 電鉄富山
    ["5:32","5:58","6:32","7:07","7:48","8:17","9:22","10:49","11:49","12:49","13:49","14:49","15:26","15:51","16:26","16:56","17:26","17:56","18:26","18:56","19:26","19:56","20:26","21:26","22:29"], # 稲荷町
    ["5:33","5:59","6:33","7:08","7:49","8:18","9:23","10:50","11:50","12:50","13:50","14:50","15:27","15:52","16:27","16:57","17:27","17:57","18:27","18:57","19:27","19:57","20:27","21:27","22:30"], # 栄町
    ["5:34","6:00","6:34","7:09","7:50","8:19","9:24","10:51","11:51","12:51","13:51","14:51","15:28","15:53","16:28","16:58","17:28","17:58","18:28","18:58","19:28","19:58","20:28","21:28","22:31"], # 不二越
    ["5:36","6:02","6:36","7:11","7:52","8:21","9:26","10:53","11:53","12:53","13:53","14:53","15:30","15:55","16:30","17:00","17:30","18:00","18:30","19:00","19:30","20:00","20:30","21:30","22:33"], # 大泉
    ["5:40","6:06","6:40","7:15","7:56","8:25","9:30","10:57","11:57","12:57","13:57","14:57","15:34","15:59","16:34","17:04","17:34","18:04","18:34","19:04","19:34","20:04","20:34","21:34","22:37"], # 南富山
    ["5:42","6:08","6:42","7:17","7:58","8:27","9:32","10:59","11:59","12:59","13:59","14:59","15:36","16:01","16:36","17:06","17:36","18:06","18:36","19:06","19:36","20:06","20:36","21:36","22:39"], # 朝菜町
    ["5:44","6:10","6:44","7:19","8:00","8:29","9:34","11:01","12:01","13:01","14:01","15:01","15:38","16:03","16:38","17:08","17:38","18:08","18:38","19:08","19:38","20:08","20:38","21:38","22:41"], # 上堀
    ["5:45","6:11","6:45","7:20","8:01","8:30","9:35","11:02","12:02","13:02","14:02","15:02","15:39","16:04","16:39","17:09","17:39","18:09","18:39","19:09","19:39","20:09","20:39","21:39","22:42"], # 小杉
    ["5:46","6:12","6:46","7:21","8:02","8:31","9:36","11:03","12:03","13:03","14:03","15:03","15:40","16:05","16:40","17:10","17:40","18:10","18:40","19:10","19:40","20:10","20:40","21:40","22:43"], # 布市
    ["5:48","6:14","6:48","7:23","8:04","8:33","9:38","11:05","12:05","13:05","14:05","15:05","15:42","16:07","16:42","17:12","17:42","18:12","18:42","19:12","19:42","20:12","20:42","21:42","22:45"], # 開発
    ["5:53","6:24","6:56","7:31","8:10","8:39","9:43","11:10","12:10","13:10","14:10","15:10","15:47","16:20","16:49","17:19","17:49","18:19","18:49","19:19","19:49","20:19","20:49","21:47","22:50"], # 月岡
    ["5:55","6:26","6:58","7:33","8:12","8:41","9:45","11:12","12:12","13:12","14:12","15:12","15:49","16:22","16:51","17:21","17:51","18:21","18:51","19:21","19:51","20:21","20:51","21:49","22:52"], # 大庄
    ["5:58","6:29","7:01","7:36","8:15","8:44","9:48","11:15","12:15","13:15","14:15","15:15","15:52","16:25","16:54","17:24","17:54","18:24","18:54","19:24","19:54","20:24","20:54","21:52","22:55"], # 上滝
    ["6:00","6:31","7:03","7:38","8:17","8:46","9:50","11:17","12:17","13:17","14:17","15:17","15:54","16:27","16:56","17:26","17:56","18:26","18:56","19:26","19:56","20:26","20:56","21:54","22:57"], # 大川寺
    ["6:04","6:35","7:07","7:42","8:21","8:50","9:54","11:21","12:21","13:21","14:21","15:21","15:58","16:31","17:00","17:30","18:00","18:30","19:00","19:30","20:00","20:30","21:00","21:58","23:01"]  # 岩峅寺
]
validate_matrix(stations_up_fujikoshi, train_nos_up_fujikoshi, times_matrix_up_fujikoshi, "不二越上り")
# -----------------------------
# 立山線 下り（立山→電鉄富山）
# -----------------------------
# 立山線 下り（立山→電鉄富山）
stations_down_tateyama = [
    "立山","本宮","有峰口","千垣","横江","岩峅寺","沢中山","釜ヶ淵","下段","榎町",
    "五百石","田添","稚子塚","寺田","越中舟橋","越中三郷","越中荏原","東新庄",
    "新庄田中","稲荷町","電鉄富山"
]
train_nos_down_tateyama = [311,313,315,317,319,321,323,1302,1308,1312,1316,1320,1324,8301,8304,8306,8308,8310,8312,8314,8316,8318,8320,8322,8324,8326,8328]

# times_matrix_down_tateyama は 21駅 × 27本 必須
# 例: データ未確定ならプレースホルダーを空文字で。あとで埋めればOK
times_matrix_down_tateyama = [
    ["","","", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],  # 311〜 の列を27本分に
    # ... 21駅分用意（各行は len(train_nos_down_tateyama)=27 列）
]
validate_matrix(stations_down_tateyama, train_nos_down_tateyama, times_matrix_down_tateyama, "立山下り")

# 立山線 上り（電鉄富山→立山）
stations_up_tateyama = [
    "電鉄富山","稲荷町","新庄田中","東新庄","越中荏原","越中三郷","越中舟橋","寺田",
    "稚子塚","田添","五百石","榎町","下段","釜ヶ淵","沢中山","岩峅寺","横江","千垣",
    "有峰口","本宮","立山"
]
train_nos_up_tateyama = [312,314,316,318,320,322,324,1303,1309,1313,1317,1321,1325,8302,8305,8307,8309,8311,8313,8315,8317,8319,8321,8323,8325,8327]

times_matrix_up_tateyama = [
    ["","","", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],  # 312〜 の列を26本分に
    # ... 21駅分用意（各行は len(train_nos_up_tateyama)=26 列）
]
validate_matrix(stations_up_tateyama, train_nos_up_tateyama, times_matrix_up_tateyama, "立山上り")

# 行き先ルール（立山線）
def tateyama_headsign(train_no):
    s = str(train_no)
    return "立山" if s.startswith("3") else "岩峅寺"

# -----------------------------
# 展開処理（両路線まとめ）
# -----------------------------
for s_idx, station in enumerate(stations_down_fujikoshi):
    for t_idx, train_no in enumerate(train_nos_down_fujikoshi):
        rows.append({
            "line": "不二越上滝線",
            "train_no": train_no,
            "direction": "下り",
            "station": station,
            "time": f"1900-01-01 {times_matrix_down_fujikoshi[s_idx][t_idx]}:00"
        })

for s_idx, station in enumerate(stations_up_fujikoshi):
    for t_idx, train_no in enumerate(train_nos_up_fujikoshi):
        rows.append({
            "line": "不二越上滝線",
            "train_no": train_no,
            "direction": "上り",
            "station": station,
            "time": f"1900-01-01 {times_matrix_up_fujikoshi[s_idx][t_idx]}:00"
        })

for s_idx, station in enumerate(stations_down_tateyama):
    for t_idx, train_no in enumerate(train_nos_down_tateyama):
        headsign = "立山" if str(train_no).startswith("3") else "岩峅寺"
        rows.append({
            "line": "立山線",
            "train_no": train_no,
            "direction": "下り",
            "station": station,
            "headsign": headsign,
            "time": f"1900-01-01 {times_matrix_down_tateyama[s_idx][t_idx]}:00"
        })

for s_idx, station in enumerate(stations_up_tateyama):
    for t_idx, train_no in enumerate(train_nos_up_tateyama):
        headsign = "立山" if str(train_no).startswith("3") else "岩峅寺"
        rows.append({
            "line": "立山線",
            "train_no": train_no,
            "direction": "上り",
            "station": station,
            "headsign": headsign,
            "time": f"1900-01-01 {times_matrix_up_tateyama[s_idx][t_idx]}:00"
        })

timetable_df = pd.DataFrame(rows)

print("=== 時刻表 (先頭) ===")
print(timetable_df.head())
print("=== 時刻表 (末尾) ===")
print(timetable_df.tail())
print("行数:", timetable_df.shape)


位置と時刻表の突合せ------------------------------------------------------------------------------------------------------------

def normalize_headsign(hs: str) -> str:
    return hs.replace("不二越・上滝線 ", "").replace(" 行き", "").strip()

results = []
for _, log_row in log_df.iterrows():
    log_headsign = normalize_headsign(str(log_row["headsign"]))
    current_station = str(log_row["station"]).strip()

    candidate_times = timetable_df[
        (timetable_df["headsign"] == log_headsign) &
        (timetable_df["station"] == current_station)
    ]

    best_match = None
    best_diff = 999
    for _, tt_row in candidate_times.iterrows():
        log_time = pd.to_datetime(log_row["timestamp"]).time()
        tt_time = pd.to_datetime(tt_row["time"]).time()
        diff = abs((log_time.hour*60 + log_time.minute) - (tt_time.hour*60 + tt_time.minute))
        if diff < best_diff:
            best_diff = diff
            best_match = tt_row

    if best_match is not None and best_diff <= 10:
        results.append({
            "timestamp": log_row["timestamp"],
            "vehicle_id": log_row["vehicle_id"],
            "headsign": log_row["headsign"],
            "station": log_row["station"],
            "train_no": best_match["train_no"]
        })

result_df = pd.DataFrame(results)
print("=== 突合せ結果 ===")
print(result_df.head())

